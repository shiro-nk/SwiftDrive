package sd.swiftserver.rk.net;

import java.io.Closeable;
import java.io.IOException;
import java.net.ServerSocket;
import java.util.ArrayList;

import sd.swiftglobal.rk.Settings;
import sd.swiftglobal.rk.expt.DisconnectException;
import sd.swiftglobal.rk.util.Logging;

/* This file is part of Swift Drive				   *
 * Copyright (C) 2015 Ryan Kerr                    *
 * Please refer to <http://www.gnu.org/licenses/>. */

public class Server implements Runnable, Settings, Logging, Closeable {
	private ArrayList<Connection> clients = new ArrayList<Connection>();
	private final ServerSocket server;
	private boolean   online = false;
	private final int PORT;
	
	public Server(int port) throws DisconnectException {
		PORT = port;
		
		try(ServerSocket server = new ServerSocket(port)) {
		}
		catch(IOException ix) {
			throw new DisconnectException(EXC_CONN, ix);
		}
	}
	
	public Server() throws DisconnectException {
		this(DEF_PORT);
	}
	
	public void run() {
		online = true;
		echo("Server intialized on port " + port, LOG_PRI);
		
		while(online) {
			try {
				Connection cli = new Connection(this, server.accept(), clients.size());
				System.out.println("scs");
				new Thread(cli).start();
				clients.add(cli);
				echo("Client " + (clients.size() - 1) + " has connected", LOG_PRI);
			}
			catch(IOException ix) {
				error("Error during client connect attempt: " + ix.getMessage(), LOG_PRI);
			}
		}

	}
	
	public int getPort() {
		return PORT;
	}
	
	public void rmClient(int id) {
		if(0 < id && id < clients.size()) clients.set(id, null);
	}
	
	/** Force close **/
	public void close() {
		online = false;
	}
}
